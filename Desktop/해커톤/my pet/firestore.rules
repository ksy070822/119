rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============ í—¬í¼ í•¨ìˆ˜ ============

    // ë¡œê·¸ì¸ ì—¬ë¶€ í™•ì¸
    function isSignedIn() {
      return request.auth != null;
    }

    // í˜„ì¬ ë¡œê·¸ì¸í•œ ìœ ì € ë¬¸ì„œ ê°€ì ¸ì˜¤ê¸°
    function userDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    // íŠ¹ì • clinicIdì— ëŒ€í•œ ë³‘ì› ì§ì›ì¸ì§€ ì²´í¬
    function isClinicStaff(clinicId) {
      return isSignedIn()
        && userDoc().data.userMode == "clinic"
        && userDoc().data.defaultClinicId == clinicId;
    }

    // ë³¸ì¸ ì—¬ë¶€ í™•ì¸
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // ============ ì‚¬ìš©ì ì»¬ë ‰ì…˜ ============
    match /users/{userId} {
      allow read: if isSignedIn() && isOwner(userId);
      allow write: if isSignedIn() && isOwner(userId);
    }

    // ============ ë°˜ë ¤ë™ë¬¼ ì»¬ë ‰ì…˜ ============
    match /pets/{petId} {
      allow read: if isSignedIn();  // ğŸ”¥ ë³‘ì› ì§ì›ë„ í« ì •ë³´ ì¡°íšŒ ê°€ëŠ¥í•˜ë„ë¡ ì™„í™”
      allow create: if isSignedIn() && isOwner(request.resource.data.userId);
      allow update, delete: if isSignedIn() && isOwner(resource.data.userId);
    }

    // ============ ë³‘ì› ì»¬ë ‰ì…˜ ============
    match /clinics/{clinicId} {
      allow read: if isSignedIn();  // ëª¨ë“  ë¡œê·¸ì¸ ì‚¬ìš©ìê°€ ë³‘ì› ì •ë³´ ì¡°íšŒ ê°€ëŠ¥
      allow update: if isClinicStaff(clinicId);
    }

    // ============ ë³‘ì› ì§ì› ì»¬ë ‰ì…˜ (ìµœìƒìœ„) ============
    // ğŸ”¥ clinics/{clinicId}/staffì—ì„œ clinicStaffë¡œ ë³€ê²½
    match /clinicStaff/{staffId} {
      allow read: if isSignedIn() && (
        resource.data.userId == request.auth.uid ||
        (resource.data.clinicId != null && isClinicStaff(resource.data.clinicId))
      );
      allow write: if isSignedIn() && (
        request.resource.data.userId == request.auth.uid ||
        (request.resource.data.clinicId != null && isClinicStaff(request.resource.data.clinicId))
      );
    }

    // ============ í™˜ì ê¸°ë¡ ì»¬ë ‰ì…˜ ============
    match /clinicPatients/{patientId} {
      allow read: if isSignedIn() && (
        (resource.data.clinicId != null && isClinicStaff(resource.data.clinicId)) ||
        isOwner(resource.data.ownerUserId)
      );
      allow write: if isSignedIn() && (
        request.resource.data.clinicId != null && isClinicStaff(request.resource.data.clinicId)
      );
    }

    // ============ ì˜ˆì•½ ì»¬ë ‰ì…˜ ============
    match /bookings/{bookingId} {
      // ì½ê¸°: ë³‘ì› ì§ì› ë˜ëŠ” ì˜ˆì•½í•œ ë³´í˜¸ì
      allow read: if isSignedIn() && (
        isClinicStaff(resource.data.clinicId) ||
        isOwner(resource.data.userId)
      );

      // ìƒì„±: ë³´í˜¸ì (ìì‹ ì˜ userIdë¡œ ì˜ˆì•½)
      allow create: if isSignedIn() && (
        isOwner(request.resource.data.userId) ||
        isClinicStaff(request.resource.data.clinicId)
      );

      // ìˆ˜ì •: ë³‘ì› ì§ì› (ìƒíƒœ ì—…ë°ì´íŠ¸ ë“±)
      allow update: if isSignedIn() && isClinicStaff(resource.data.clinicId);

      // ì‚­ì œ: ë³‘ì› ì§ì› ë˜ëŠ” ì˜ˆì•½í•œ ë³´í˜¸ì
      allow delete: if isSignedIn() && (
        isClinicStaff(resource.data.clinicId) ||
        isOwner(resource.data.userId)
      );
    }

    // ============ ì§„ë‹¨ì„œ ì»¬ë ‰ì…˜ ============
    match /diagnoses/{diagId} {
      // ğŸ”¥ ì½ê¸°: ë³‘ì› ì§ì› (clinicId ê¸°ì¤€) ë˜ëŠ” ì†Œìœ ì (ownerId ê¸°ì¤€)
      // ë³‘ì› ëª¨ë“œì—ì„œ petIdë§Œìœ¼ë¡œ ì¡°íšŒí•  ë•Œë„ ê¶Œí•œ ë¶€ì—¬
      allow read: if isSignedIn() && (
        // ë³‘ì› ì§ì›: clinicIdê°€ ìˆìœ¼ë©´ í™•ì¸
        (resource.data.clinicId != null && isClinicStaff(resource.data.clinicId)) ||
        // ë³´í˜¸ì: ownerId ë˜ëŠ” userIdê°€ ë³¸ì¸ì´ë©´ í—ˆìš©
        isOwner(resource.data.ownerId) ||
        (resource.data.userId != null && isOwner(resource.data.userId))
      );

      // ìƒì„±: ë³‘ì› ì§ì› ë˜ëŠ” ë³´í˜¸ì (ë³¸ì¸)
      allow create: if isSignedIn() && (
        (request.resource.data.clinicId != null && isClinicStaff(request.resource.data.clinicId)) ||
        isOwner(request.resource.data.ownerId) ||
        (request.resource.data.userId != null && isOwner(request.resource.data.userId))
      );

      // ìˆ˜ì •: ë³‘ì› ì§ì› ë˜ëŠ” ì†Œìœ ì
      allow update: if isSignedIn() && (
        (resource.data.clinicId != null && isClinicStaff(resource.data.clinicId)) ||
        isOwner(resource.data.ownerId) ||
        (resource.data.userId != null && isOwner(resource.data.userId))
      );

      // ì‚­ì œ: ì†Œìœ ìë§Œ
      allow delete: if isSignedIn() && (
        isOwner(resource.data.ownerId) ||
        (resource.data.userId != null && isOwner(resource.data.userId))
      );
    }

    // ============ ì‚¬ì „ ë¬¸ì§„ ì»¬ë ‰ì…˜ ============
    match /preQuestionnaires/{qId} {
      // ğŸ”¥ ì½ê¸°: ë³‘ì› ì§ì› (clinicId ê¸°ì¤€) ë˜ëŠ” ì†Œìœ ì
      allow read: if isSignedIn() && (
        (resource.data.clinicId != null && isClinicStaff(resource.data.clinicId)) ||
        isOwner(resource.data.ownerId) ||
        (resource.data.userId != null && isOwner(resource.data.userId))
      );

      // ìƒì„±: ë³‘ì› ì§ì› ë˜ëŠ” ë³´í˜¸ì (ë³¸ì¸)
      allow create: if isSignedIn() && (
        (request.resource.data.clinicId != null && isClinicStaff(request.resource.data.clinicId)) ||
        isOwner(request.resource.data.ownerId) ||
        (request.resource.data.userId != null && isOwner(request.resource.data.userId))
      );

      // ìˆ˜ì •: ë³‘ì› ì§ì› ë˜ëŠ” ì†Œìœ ì
      allow update: if isSignedIn() && (
        (resource.data.clinicId != null && isClinicStaff(resource.data.clinicId)) ||
        isOwner(resource.data.ownerId) ||
        (resource.data.userId != null && isOwner(resource.data.userId))
      );

      // ì‚­ì œ: ì†Œìœ ìë§Œ
      allow delete: if isSignedIn() && (
        isOwner(resource.data.ownerId) ||
        (resource.data.userId != null && isOwner(resource.data.userId))
      );
    }

    // ============ í™˜ì ê¸°ë¡ (ì§„ë£Œ ê¸°ë¡) ì»¬ë ‰ì…˜ ============
    match /medicalRecords/{mrId} {
      // ğŸ”¥ ì½ê¸°: ë³‘ì› ì§ì› (clinicId ê¸°ì¤€) ë˜ëŠ” ì†Œìœ ì
      allow read: if isSignedIn() && (
        (resource.data.clinicId != null && isClinicStaff(resource.data.clinicId)) ||
        isOwner(resource.data.ownerId) ||
        (resource.data.userId != null && isOwner(resource.data.userId))
      );

      // ìƒì„±: ë³‘ì› ì§ì›ë§Œ
      allow create: if isSignedIn() && (
        request.resource.data.clinicId != null && isClinicStaff(request.resource.data.clinicId)
      );

      // ìˆ˜ì •: ë³‘ì› ì§ì›ë§Œ
      allow update: if isSignedIn() && (
        resource.data.clinicId != null && isClinicStaff(resource.data.clinicId)
      );

      // ì‚­ì œ: ë³‘ì› ì§ì› ë˜ëŠ” ì†Œìœ ì
      allow delete: if isSignedIn() && (
        (resource.data.clinicId != null && isClinicStaff(resource.data.clinicId)) ||
        isOwner(resource.data.ownerId) ||
        (resource.data.userId != null && isOwner(resource.data.userId))
      );
    }

    // ============ ì§„ë£Œ ê²°ê³¼ ì»¬ë ‰ì…˜ ============
    match /clinicResults/{resultId} {
      // ğŸ”¥ ì½ê¸°: ë³‘ì› ì§ì› ë˜ëŠ” ë³´í˜¸ì (userIdì™€ ownerId ë‘˜ ë‹¤ ì§€ì›)
      allow read: if isSignedIn() && (
        (resource.data.clinicId != null && isClinicStaff(resource.data.clinicId)) ||
        isOwner(resource.data.userId) ||
        isOwner(resource.data.ownerId)
      );

      // ìƒì„±/ìˆ˜ì •: ë³‘ì› ì§ì›ë§Œ
      allow create, update: if isSignedIn() && (
        request.resource.data.clinicId != null && isClinicStaff(request.resource.data.clinicId)
      );

      // ì‚­ì œ: ë³‘ì› ì§ì›ë§Œ
      allow delete: if isSignedIn() && (
        resource.data.clinicId != null && isClinicStaff(resource.data.clinicId)
      );
    }

    // ============ ì¼ì¼ ì¼€ì–´ ë¡œê·¸ ì»¬ë ‰ì…˜ ============
    match /dailyLogs/{logId} {
      allow read, write: if isSignedIn();  // ë³¸ì¸ ë°ì´í„°ë§Œ ì½ê³  ì“¸ ìˆ˜ ìˆë„ë¡ í•„í„°ë§ì€ í´ë¼ì´ì–¸íŠ¸ì—ì„œ
    }

    // ============ OCR ë¬¸ì„œ ì»¬ë ‰ì…˜ ============
    match /records/{recordId} {
      allow read, write: if isSignedIn();  // ë³¸ì¸ ë°ì´í„°ë§Œ ì½ê³  ì“¸ ìˆ˜ ìˆë„ë¡ í•„í„°ë§ì€ í´ë¼ì´ì–¸íŠ¸ì—ì„œ
    }

    // ============ í†µê³„ ì»¬ë ‰ì…˜ ============
    match /clinicStats/{clinicId} {
      allow read: if isClinicStaff(clinicId);
      allow write: if false;  // í†µê³„ëŠ” Cloud Functionsì—ì„œë§Œ ì—…ë°ì´íŠ¸
    }

    // ============ ê¸°ë³¸ ê±°ë¶€ ============
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
